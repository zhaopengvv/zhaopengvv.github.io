<!DOCTYPE html><html lang="zh-CN"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><meta name="author" content="Yourname"><title>postgreSQL中的TOAST技术 · zhpng</title><meta name="description" content="摘要：介绍postgreSQL中的TOAST技术


​		TOAST（The Oversize-Attribute Storage Technique）技术是PG提供的一种存储大数据的机制。
​		要理解TOAST，我们要先理解页（BLOCK）的概念。在PG中，页是数据在文件存储中的基本单位，其大"><meta name="keywords" content="Blog,博客,Hexo"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="renderer" content="webkit"><link rel="shortcut icon" type="image/x-icon" href="/images/favicon.webp"><link rel="stylesheet" href="/css/style.css"><link rel="stylesheet" href="/css/blog_basic.css"><link rel="stylesheet" href="/css/font-awesome.min.css"><link rel="stylesheet" href="/css/insight.css"><link rel="stylesheet" href="/css/search.css"><link rel="alternate" type="application/atom+xml" title="ATOM 1.0" href="/atom.xml"><script src="/js/jquery.js"></script><meta name="generator" content="Hexo 6.3.0"></head><body><div class="page-top animated fadeInDown"><div class="nav"><li> <a href="/">Home</a></li><li> <a href="/archives">Archives</a></li><li> <a href="/tags">Tags</a></li><li> <a href="/about">About</a></li><li> <a href="/links">Links</a></li></div><div class="information"><div class="nav_right_btn"><li><a class="fa fa-chevron-left" onclick="window.history.go(-1)"> </a></li><li><a class="fa fa-search" onclick="openWindow();"></a></li></div><div class="avatar"><img src="/images/logo.webp"></div></div></div><div class="sidebar animated fadeInDown"><div class="sidebar-top"><div class="logo-title"><div class="title"><img src="/images/logo@2x.webp" style="width:220px;" alt="favicon"><h3 title=""><a href="/">zhpng</a></h3><div class="description"><p>A simple and beautiful blog</p></div></div><ul class="social-links"><li><a target="_blank" rel="noopener" href="https://github.com/Lhcfl"><i class="fa fa-github"></i></a></li><li><a href="mailto:yourname@example.com"><i class="fa fa-envelope"></i></a></li><li><a target="_blank" rel="noopener" href="https://zhihu.com/people/jin-xin-4-68"><i class="fa fa-mortar-board"></i></a></li></ul></div></div><div class="footer"><div class="p"> <span> 全站CC-BY-SA-3.0 </span><i class="fa fa-star"></i><span> Yourname</span></div><div class="by_farbox"><span>Powered by </span><a href="https://hexo.io/zh-cn/" target="_blank">Hexo </a><span> & </span><span>Anatolo </span></div><div class="beian"></div></div></div><div class="main"><div class="autopagerize_page_element"><div class="content"><div class="post-page"><div class="post animated fadeInDown"><div class="post-title"><h3><a>postgreSQL中的TOAST技术</a></h3></div><div class="post-content"><p><p>摘要：介绍postgreSQL中的TOAST技术</p>
<span id="more"></span>

<p>​		TOAST（The Oversize-Attribute Storage Technique）技术是PG提供的一种存储大数据的机制。</p>
<p>​		要理解TOAST，我们要先理解<strong>页（BLOCK）</strong>的概念。在PG中，页是数据在文件存储中的基本单位，其大小是固定的且只能在编译期指定，之后无法修改，默认的大小为8KB。同时，PG不允许一行数据跨页存储。那么对于超长的行数据，PG就会启动TOAST，将大的字段压缩或切片成多个物理行存到另一张系统表中（<strong>TOAST表</strong>），这种存储方式叫<strong>行外存储</strong>。</p>
<p>​		在PostgreSQL中只有具有变长行为的数据类型（代码内部常称为varlena类型）才支持TOAST，比如TEXT数据类型。在向支持TOAST的属性中存储超过BLCKSZ&#x2F;4字节（通常是2K）的数据时，TOAST机制才会被触发。在变长数据类型中，数值的前两位表示数值的存储方式：</p>
<ul>
<li>如果是00，该数值是普通的未TOAST的数值。</li>
<li>如果是01，表示该数据被压缩过，剩下30位表示压缩后的数据大小，在这4字节之后还会附加4字节，表示未压缩的数据大小。</li>
<li>如果是1x，数据头部仅用一字节。当存储的是短字符串（小于128字节），剩下7位表示字符串长度。当该字节为10000000时，表明这是线外存储的数据，紧随其后使用1字节记录指针大小，数据区域记录TOAST指针。</li>
</ul>
<p><strong>注意：线外存储时，也可能进行压缩，这种情况通过TOAST指针中的va_rawsize和va_extsize来进行比较。</strong>？？？？</p>
<p>​		线外存储的数据会保存在称为TOAST表的普通表中。如果一个表中有一个属性是可TOAST的，那么该表将会有一个可关联的TOAST表，其OID存储在表的基本信息（也就是pg_class中的元组）的reltoastrelid属性中。如果没有关联的TOAST表，reltoastrelid属性为0。</p>
<p>​		TOAST机制有四种不同的存储策略（表中的Storage属性）：</p>
<ul>
<li>PLAN：避免压缩或者线外存储。不支持toast的数据类型</li>
<li>EXTENDED：允许压缩和线外存储，大多数可TOAST的数据类型的缺省值。</li>
<li>EXTERNAL：允许线外存储但是不允许压缩。可以使text和bytea字段上的字串操作更快。</li>
<li>MAIN：允许压缩，但是不允许线外存储。实际上这样的数据类型仍然可以进行线外存储。</li>
</ul>
<p>存储策略可以使用ALTER TABLE SET STORAGE语句修改。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">db=&gt; create table t1 (c1 int, c2 text, c3 bytea);</span><br><span class="line">CREATE TABLE</span><br><span class="line">db=&gt; \d+ t1</span><br><span class="line">                                            Table &quot;public.t1&quot;</span><br><span class="line"> Column |  Type   | Collation | Nullable | Default | Storage  | Compression | Stats target | Description </span><br><span class="line">--------+---------+-----------+----------+---------+----------+-------------+--------------+-------------</span><br><span class="line"> c1     | integer |           |          |         | plain    |             |              | </span><br><span class="line"> c2     | text    |           |          |         | extended |             |              | </span><br><span class="line"> c3     | bytea   |           |          |         | extended |             |              | </span><br><span class="line">Access method: heap</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">db=&gt; select relname, reltoastrelid from pg_class where relname = &#x27;t1&#x27;;</span><br><span class="line"> relname | reltoastrelid </span><br><span class="line">---------+---------------</span><br><span class="line"> t1      |         32785</span><br><span class="line">(1 row)</span><br><span class="line"></span><br><span class="line">db=&gt; select relname, relnamespace from pg_class where oid  = &#x27;32785&#x27;;</span><br><span class="line">    relname     | relnamespace </span><br><span class="line">----------------+--------------</span><br><span class="line"> pg_toast_32782 |           99</span><br><span class="line">(1 row)</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">-- pg_toast_32777的命名空间</span><br><span class="line">db=&gt; select nspname from pg_namespace where oid = 99;</span><br><span class="line">-[ RECORD 1 ]-----</span><br><span class="line">nspname | pg_toast</span><br><span class="line"></span><br><span class="line">--TOAST表的定义</span><br><span class="line">db=&gt; \d+ pg_toast.pg_toast_32777</span><br><span class="line">TOAST table &quot;pg_toast.pg_toast_32777&quot;</span><br><span class="line">   Column   |  Type   | Storage </span><br><span class="line">------------+---------+---------</span><br><span class="line"> chunk_id   | oid     | plain</span><br><span class="line"> chunk_seq  | integer | plain</span><br><span class="line"> chunk_data | bytea   | plain</span><br><span class="line">Owning table: &quot;public.t1&quot;</span><br><span class="line">Indexes:</span><br><span class="line">    &quot;pg_toast_32777_index&quot; PRIMARY KEY, btree (chunk_id, chunk_seq)</span><br><span class="line">Access method: heap</span><br></pre></td></tr></table></figure>

<p>TOAST表有三个字段：</p>
<ul>
<li><strong>chunk_id</strong> ：用来表示特定 TOAST 值的 OID ，可以理解为具有同样 chunk_id 值的所有行组成原表的 TOAST 字段的一行数据。</li>
<li><strong>chunk_seq</strong>： 用来表示该行数据在整个数据中的位置。</li>
<li><strong>chunk_data</strong> ： 该Chunk实际的数据。</li>
</ul>
<p>对应的TOAST表的数据结构：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"> */</span><br><span class="line">typedef struct varatt_external</span><br><span class="line">&#123;</span><br><span class="line">	int32		va_rawsize;		/* Original data size (includes header) */</span><br><span class="line">	uint32		va_extinfo;		/* External saved size (without header) and</span><br><span class="line">								 * compression method */</span><br><span class="line">	Oid			va_valueid;		/* Unique ID of value within TOAST table */</span><br><span class="line">	Oid			va_toastrelid;	/* RelID of TOAST table containing it */</span><br><span class="line">&#125; varatt_external;</span><br></pre></td></tr></table></figure>

<p>探究TOAST机制</p>
<p>​		c2只有10个字符，所以没有压缩，也没有行外存储。然后我们使用如下 SQL 语句增加 c2的长度，每次增长1倍，同时观察 c2的长度。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">db=&gt; insert into t1 values(1, &#x27;title&#x27;, &#x27;0123456789&#x27;);                                                       </span><br><span class="line">INSERT 0 1 </span><br><span class="line">db=&gt; select * from t1;</span><br><span class="line"> c1 |  c2   |           c3           </span><br><span class="line">----+-------+------------------------</span><br><span class="line">  1 | title | \x30313233343536373839</span><br><span class="line">(1 row)</span><br><span class="line"></span><br><span class="line">db=&gt; select * from pg_toast.pg_toast_32782;</span><br><span class="line"> chunk_id | chunk_seq | chunk_data </span><br><span class="line">----------+-----------+------------</span><br><span class="line">(0 rows)</span><br></pre></td></tr></table></figure>

<p>​		反复执行如上过程，直到 pg_toast_32782表中有数据。直到 content 的长度为327680时（已远远超过页大小 8K），对应 TOAST 表中才有了数据，且长度都是略小于2K，这是因为 extended 策略下，先启用了压缩，然后才使用行外存储。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">db=&gt; update t1 set c2=c2||c2 where c1=1;</span><br><span class="line">UPDATE 1</span><br><span class="line">.....</span><br><span class="line"></span><br><span class="line">db=&gt; select c1, length(c2) from t1;</span><br><span class="line"> c1 |  length  </span><br><span class="line">----+----------</span><br><span class="line">  1 | 83886080</span><br><span class="line">(1 row)</span><br><span class="line"></span><br><span class="line">db=&gt; select * from pg_toast.pg_toast_32782;</span><br><span class="line">-[ RECORD 1 ]-----------------------------------------------------------------------------------------------</span><br><span class="line">chunk_id   | 32795</span><br><span class="line">chunk_seq  | 0</span><br><span class="line">chunk_data | .....</span><br><span class="line">-[ RECORD 2 ]-----------------------------------------------------------------------------------------------</span><br><span class="line">chunk_id   | 32795</span><br><span class="line">chunk_seq  | 1</span><br><span class="line">chunk_data | .....</span><br><span class="line">-[ RECORD 3 ]-----------------------------------------------------------------------------------------------</span><br><span class="line">chunk_id   | 32795</span><br><span class="line">chunk_seq  | 2</span><br><span class="line">chunk_data | .....</span><br><span class="line"></span><br><span class="line">db=&gt; select chunk_id,chunk_seq,length(chunk_data) from pg_toast.pg_toast_32782;</span><br><span class="line"> chunk_id | chunk_seq | length </span><br><span class="line">----------+-----------+--------</span><br><span class="line">    32795 |         0 |   1996</span><br><span class="line">    32795 |         1 |   1996</span><br><span class="line">    32795 |         2 |   1996</span><br><span class="line">    32795 |         3 |   1996</span><br><span class="line">    32795 |         4 |   1996</span><br><span class="line">    32795 |         5 |   1996</span><br><span class="line">    32795 |         6 |   1996</span><br><span class="line">    32795 |         7 |   1996</span><br><span class="line">    32795 |         8 |   1996</span><br><span class="line">    32795 |         9 |   1996</span><br><span class="line">    32795 |        10 |   1996</span><br><span class="line">    32795 |        11 |   1996</span><br><span class="line">    32795 |        12 |   1996</span><br></pre></td></tr></table></figure>

<p>参考：<a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/142281841">https://zhuanlan.zhihu.com/p/142281841</a></p>
</p><div class="tip">本文采用CC-BY-SA-3.0协议，转载请注明出处<br>Author: zhaopengvv</div></div><div class="post-footer"><div class="meta"><div class="info"><i class="fa fa-sun-o"></i><span class="date">2023-10-29</span><a class="tag" href="/categories/数据库/" title="数据库">数据库 </a><i class="fa fa-tag"></i><a class="tag" href="/tags/postgres/" title="postgres">postgres </a><span class="leancloud_visitors"></span><span>About 1303 words, 4 min 20 sec  read</span></div></div></div></div><div class="share"><div class="evernote"><a class="fa fa-bookmark" href="" onclick="javascript:join_favorite()" ref="sidebar"></a></div><div class="weibo"><a class="fa fa-weibo" href="javascript:void((function(s,d,e){try{}catch(e){}var f='http://service.weibo.com/share/share.php?',u=d.location.href,p=['url=',e(u),'&amp;title=',e(d.title),'&amp;appkey=2924220432'].join('');function a(){if(!window.open([f,p].join(''),'mb',['toolbar=0,status=0,resizable=1,width=620,height=450,left=',(s.width-620)/2,',top=',(s.height-450)/2].join('')))u.href=[f,p].join('');};if(/Firefox/.test(navigator.userAgent)){setTimeout(a,0)}else{a()}})(screen,document,encodeURIComponent));"></a></div><div class="twitter"><a class="fa fa-twitter" target="_blank" rel="noopener" href="http://twitter.com/home?status=,http://example.com/2023/10/29/postgreSQL中的TOAST技术/,zhpng,postgreSQL中的TOAST技术,;"></a></div></div><div class="pagination"><ul class="clearfix"><li class="pre pagbuttons"><a class="btn" role="navigation" href="/2023/10/29/2023-10-29%20hexo+github%E6%90%AD%E5%BB%BA%E4%B8%AA%E4%BA%BA%E5%8D%9A%E5%AE%A2/" title="hexo + github 搭建个人博客">Previous</a></li><li class="next pagbuttons"><a class="btn" role="navigation" href="/2023/10/29/%E5%85%B1%E4%BA%AB%E5%86%85%E5%AD%98%E4%BB%8B%E7%BB%8D/" title="计划共享内存">Next</a></li></ul></div><script src="/js/visitors.js"></script></div></div></div></div><script src="/js/jquery-migrate-1.2.1.min.js"></script><script src="/js/jquery.appear.js"></script><script src="/js/add-bookmark.js"></script><script>(function(window){var INSIGHT_CONFIG={TRANSLATION:{POSTS:"Posts",PAGES:"Pages",CATEGORIES:"Categories",TAGS:"Tags",UNTITLED:"(Untitled)",},CONTENT_URL:"/content.json",};window.INSIGHT_CONFIG=INSIGHT_CONFIG})(window);</script><script src="/js/insight.js" defer></script><div class="searchbox ins-search"><div class="searchbox-container ins-search-container"><div class="searchbox-input-wrapper"><input class="searchbox-input ins-search-input" type="text" placeholder="Search..."><span class="searchbox-close"><a class="fa fa-times-circle" onclick="closeWindow();"></a></span></div><div class="searchbox-result-wrapper ins-section-wrapper"><div class="ins-section-container"><p>Seraching...</p></div></div></div></div></body></html>